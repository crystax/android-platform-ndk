set(CMAKE_BUILD_TYPE RELEASE)

if(UNIX AND NOT APPLE)
  set(LINUX TRUE)
endif()

if(WIN32)
  set(PYCORE_TARGET_NAME "python27")
else()
  set(PYCORE_TARGET_NAME "python2.7")
endif()

if(LINUX)
  set(CMAKE_C_FLAGS "-DPy_BUILD_CORE -DPLATFORM=\\\"linux\\\"")
  set(CMAKE_SHARED_LINKER_FLAGS "-Wl,--no-undefined")
  set(MY_DL_LIBS m pthread util dl)
elseif(APPLE)
  set(CMAKE_C_FLAGS "-DPy_BUILD_CORE -DPLATFORM=\\\"darwin\\\"")
  set(CMAKE_SHARED_LINKER_FLAGS "-framework SystemConfiguration -framework CoreFoundation")
  set(MY_DL_LIBS m pthread util dl)
elseif(WIN32)
  set(CMAKE_C_FLAGS "-DPy_BUILD_CORE")
else()
  message(FATAL_ERROR "Unknown platform")
endif()

include_directories(${MY_PYTHON_SRC_ROOT}/Include)
include_directories(${MY_PYTHON_SRC_ROOT}/Modules/zlib)
include_directories(${CMAKE_CURRENT_LIST_DIR})

set(SRC_FILES
  ${CMAKE_CURRENT_LIST_DIR}/config.c
  ${CMAKE_CURRENT_LIST_DIR}/getpath.c

  ${MY_PYTHON_SRC_ROOT}/Python/_warnings.c
  ${MY_PYTHON_SRC_ROOT}/Python/asdl.c
  ${MY_PYTHON_SRC_ROOT}/Python/ast.c
  ${MY_PYTHON_SRC_ROOT}/Python/bltinmodule.c
  ${MY_PYTHON_SRC_ROOT}/Python/ceval.c
  ${MY_PYTHON_SRC_ROOT}/Python/codecs.c
  ${MY_PYTHON_SRC_ROOT}/Python/compile.c
  ${MY_PYTHON_SRC_ROOT}/Python/dtoa.c
  ${MY_PYTHON_SRC_ROOT}/Python/errors.c
  ${MY_PYTHON_SRC_ROOT}/Python/formatter_string.c
  ${MY_PYTHON_SRC_ROOT}/Python/formatter_unicode.c
  ${MY_PYTHON_SRC_ROOT}/Python/frozen.c
  ${MY_PYTHON_SRC_ROOT}/Python/future.c
  ${MY_PYTHON_SRC_ROOT}/Python/getargs.c
  ${MY_PYTHON_SRC_ROOT}/Python/getcompiler.c
  ${MY_PYTHON_SRC_ROOT}/Python/getcopyright.c
  ${MY_PYTHON_SRC_ROOT}/Python/getopt.c
  ${MY_PYTHON_SRC_ROOT}/Python/getplatform.c
  ${MY_PYTHON_SRC_ROOT}/Python/getversion.c
  ${MY_PYTHON_SRC_ROOT}/Python/graminit.c
  ${MY_PYTHON_SRC_ROOT}/Python/import.c
  ${MY_PYTHON_SRC_ROOT}/Python/importdl.c
  ${MY_PYTHON_SRC_ROOT}/Python/marshal.c
  ${MY_PYTHON_SRC_ROOT}/Python/modsupport.c
  ${MY_PYTHON_SRC_ROOT}/Python/mysnprintf.c
  ${MY_PYTHON_SRC_ROOT}/Python/mystrtoul.c
  ${MY_PYTHON_SRC_ROOT}/Python/peephole.c
  ${MY_PYTHON_SRC_ROOT}/Python/pyarena.c
  ${MY_PYTHON_SRC_ROOT}/Python/pyctype.c
  ${MY_PYTHON_SRC_ROOT}/Python/pyfpe.c
  ${MY_PYTHON_SRC_ROOT}/Python/pymath.c
  ${MY_PYTHON_SRC_ROOT}/Python/pystate.c
  ${MY_PYTHON_SRC_ROOT}/Python/pystrcmp.c
  ${MY_PYTHON_SRC_ROOT}/Python/pystrtod.c
  ${MY_PYTHON_SRC_ROOT}/Python/Python-ast.c
  ${MY_PYTHON_SRC_ROOT}/Python/pythonrun.c
  ${MY_PYTHON_SRC_ROOT}/Python/random.c
  ${MY_PYTHON_SRC_ROOT}/Python/structmember.c
  ${MY_PYTHON_SRC_ROOT}/Python/symtable.c
  ${MY_PYTHON_SRC_ROOT}/Python/sysmodule.c
  ${MY_PYTHON_SRC_ROOT}/Python/thread.c
  ${MY_PYTHON_SRC_ROOT}/Python/traceback.c

  ${MY_PYTHON_SRC_ROOT}/Parser/acceler.c
  ${MY_PYTHON_SRC_ROOT}/Parser/bitset.c
  ${MY_PYTHON_SRC_ROOT}/Parser/firstsets.c
  ${MY_PYTHON_SRC_ROOT}/Parser/grammar.c
  ${MY_PYTHON_SRC_ROOT}/Parser/grammar1.c
  ${MY_PYTHON_SRC_ROOT}/Parser/listnode.c
  ${MY_PYTHON_SRC_ROOT}/Parser/metagrammar.c
  ${MY_PYTHON_SRC_ROOT}/Parser/myreadline.c
  ${MY_PYTHON_SRC_ROOT}/Parser/node.c
  ${MY_PYTHON_SRC_ROOT}/Parser/parser.c
  ${MY_PYTHON_SRC_ROOT}/Parser/parsetok.c
  ${MY_PYTHON_SRC_ROOT}/Parser/tokenizer.c

  ${MY_PYTHON_SRC_ROOT}/Objects/abstract.c
  ${MY_PYTHON_SRC_ROOT}/Objects/boolobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/bufferobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/bytearrayobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/bytes_methods.c
  ${MY_PYTHON_SRC_ROOT}/Objects/capsule.c
  ${MY_PYTHON_SRC_ROOT}/Objects/cellobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/classobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/cobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/codeobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/complexobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/descrobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/dictobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/enumobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/exceptions.c
  ${MY_PYTHON_SRC_ROOT}/Objects/fileobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/floatobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/frameobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/funcobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/genobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/intobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/iterobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/listobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/longobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/memoryobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/methodobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/moduleobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/object.c
  ${MY_PYTHON_SRC_ROOT}/Objects/obmalloc.c
  ${MY_PYTHON_SRC_ROOT}/Objects/rangeobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/setobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/sliceobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/stringobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/structseq.c
  ${MY_PYTHON_SRC_ROOT}/Objects/tupleobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/typeobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/unicodectype.c
  ${MY_PYTHON_SRC_ROOT}/Objects/unicodeobject.c
  ${MY_PYTHON_SRC_ROOT}/Objects/weakrefobject.c

  ${MY_PYTHON_SRC_ROOT}/Modules/_bisectmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_codecsmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_collectionsmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_csv.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_functoolsmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_heapqmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_hotshot.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_io/_iomodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_io/_iomodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_io/bufferedio.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_io/bytesio.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_io/fileio.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_io/iobase.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_io/stringio.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_io/textio.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_json.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_localemodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_lsprof.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_math.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_randommodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_sre.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_struct.c
  ${MY_PYTHON_SRC_ROOT}/Modules/_weakref.c
  ${MY_PYTHON_SRC_ROOT}/Modules/arraymodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/audioop.c
  ${MY_PYTHON_SRC_ROOT}/Modules/binascii.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cjkcodecs/_codecs_cn.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cjkcodecs/_codecs_hk.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cjkcodecs/_codecs_iso2022.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cjkcodecs/_codecs_jp.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cjkcodecs/_codecs_kr.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cjkcodecs/_codecs_tw.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cjkcodecs/multibytecodec.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cmathmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cPickle.c
  ${MY_PYTHON_SRC_ROOT}/Modules/cStringIO.c
  ${MY_PYTHON_SRC_ROOT}/Modules/datetimemodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/errnomodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/future_builtins.c
  ${MY_PYTHON_SRC_ROOT}/Modules/gcmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/getbuildinfo.c
  ${MY_PYTHON_SRC_ROOT}/Modules/itertoolsmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/main.c
  ${MY_PYTHON_SRC_ROOT}/Modules/mathmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/md5.c
  ${MY_PYTHON_SRC_ROOT}/Modules/md5module.c
  ${MY_PYTHON_SRC_ROOT}/Modules/mmapmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/operator.c
  ${MY_PYTHON_SRC_ROOT}/Modules/parsermodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/rotatingtree.c
  ${MY_PYTHON_SRC_ROOT}/Modules/sha256module.c
  ${MY_PYTHON_SRC_ROOT}/Modules/sha512module.c
  ${MY_PYTHON_SRC_ROOT}/Modules/shamodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/signalmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/stropmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/symtablemodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/threadmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/timemodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/xxsubtype.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zipimport.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlib/adler32.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlib/crc32.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlib/deflate.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlib/infback.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlib/inffast.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlib/inflate.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlib/inftrees.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlib/trees.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlib/zutil.c
  ${MY_PYTHON_SRC_ROOT}/Modules/zlibmodule.c
)

set(SRC_FILES_POSIX
  ${MY_PYTHON_SRC_ROOT}/Modules/fcntlmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/pwdmodule.c
  ${MY_PYTHON_SRC_ROOT}/Modules/termios.c
  ${MY_PYTHON_SRC_ROOT}/Modules/posixmodule.c
  ${MY_PYTHON_SRC_ROOT}/Python/dynload_shlib.c
)

set(SRC_FILES_WINAPI
  ${MY_PYTHON_SRC_ROOT}/PC/_subprocess.c
  ${MY_PYTHON_SRC_ROOT}/PC/_winreg.c
  ${MY_PYTHON_SRC_ROOT}/PC/dl_nt.c
  ${MY_PYTHON_SRC_ROOT}/PC/import_nt.c
  ${MY_PYTHON_SRC_ROOT}/PC/msvcrtmodule.c
  ${CMAKE_CURRENT_LIST_DIR}/dynload_win.c
  ${CMAKE_CURRENT_LIST_DIR}/posixmodule.c
)

set(SRC_FILES_DARWIN
  ${MY_PYTHON_SRC_ROOT}/Mac/Modules/_scproxy.c
)

if(WIN32)
  list(APPEND SRC_FILES ${SRC_FILES_WINAPI})
else()
  list(APPEND SRC_FILES ${SRC_FILES_POSIX})
endif()

if(APPLE)
  list(APPEND SRC_FILES ${SRC_FILES_DARWIN})
endif()

add_library(${PYCORE_TARGET_NAME} SHARED ${SRC_FILES})
target_link_libraries(${PYCORE_TARGET_NAME} ${MY_DL_LIBS})
set_target_properties(${PYCORE_TARGET_NAME} PROPERTIES DEFINE_SYMBOL "Py_ENABLE_SHARED")

if(WIN32)
  set_target_properties(${PYCORE_TARGET_NAME} PROPERTIES PREFIX "")
endif()

if (APPLE)
  set_target_properties(${PYCORE_TARGET_NAME} PROPERTIES SUFFIX ".so")
  add_custom_command(TARGET ${PYCORE_TARGET_NAME} POST_BUILD COMMAND
    install_name_tool -id lib${PYCORE_TARGET_NAME}.so lib${PYCORE_TARGET_NAME}.so)
endif()
